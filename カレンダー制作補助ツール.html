<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>atwikiカレンダー生成 & プレビュー</title>
    <style>
        /* ツール全体の基本スタイル */
        body { font-family: sans-serif; background-color: #f0f2f5; padding: 20px; color: #333; }
        .container { max-width: 1500px; margin: auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .controls { margin-bottom: 20px; padding: 15px; background: #eef2ff; border-radius: 8px; }
        textarea { width: 100%; height: 200px; font-family: monospace; margin: 10px 0; box-sizing: border-box; }
        button { padding: 10px 20px; cursor: pointer; border-radius: 4px; border: none; font-weight: bold; }
        .gen-btn { background: #5c67f2; color: white; }
        .copy-btn { background: #34d399; color: white; }
        
        hr { margin: 30px 0; border: 0; border-top: 2px solid #ddd; }
        h3 { color: #5c67f2; }

        /* --- 修正版CSS（プレビュー用） --- */
        #preview-area { padding: 20px; background: #fff; line-height: 0; } /* line-height: 0 は隙間対策 */

        /* 1. 条件に一致するテーブルの特定とレイアウト */
        #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]):has(tr:nth-child(2) td:nth-child(7)):not(:has(tr:nth-child(2) td:nth-child(8))) {
            display: inline-table !important; /* floatを廃止 */
            vertical-align: top !important;
            width: 300px !important;
            border: none !important;
            border-collapse: separate !important;
            border-spacing: 2px !important;
            margin-right: 1em !important; /* 左から右余白に変更 */
            margin-bottom: 2em !important;
            table-layout: fixed !important;
            background: none !important;
            border-bottom: 2px solid #eeeeff !important;
            line-height: normal; /* 文字の高さは戻す */
        }

        /* 2. AtWikiの自動挿入 <br> を無効化 */
        #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]) + br {
            display: none !important;
        }

        /* 3. 画面が十分広い時だけ最大4つで改行する（レスポンシブ対応） */
        @media (min-width: 1280px) {
            #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]):nth-of-type(4n+1) {
                clear: both !important;
            }
        }

        /* 4. 回り込み・混入防止 */
        #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]) + *:not(table):not(br) {
            clear: both !important;
            display: block !important;
        }

        /* 5. セル設定 */
        #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]) td {
            border: none !important;
            padding: 0 !important;
            height: 28px !important;
            line-height: 28px !important;
            text-align: center !important;
            vertical-align: middle !important;
            background-image: none !important;
            overflow: hidden;
        }

        /* 6. 行の背景リセット */
        #preview-area table:has(tr:nth-child(1) td[style*="#ccccff"]) tr {
            background: none !important;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>atwikiカレンダー生成ツール</h2>
    
    <div class="controls">
        <label>対象年: </label>
        <input type="number" id="year" value="2026" style="width: 80px; padding: 5px;">
        <button class="gen-btn" onclick="generate()">カレンダー生成</button>
        <button class="copy-btn" onclick="copyText()">コードをコピー</button>
    </div>

    <textarea id="output" readonly placeholder="ここにatwiki構文が出力されます"></textarea>

    <hr>

    <h3>プレビュー (提供されたCSSを適用済み)</h3>
    <div id="preview-area"></div>
</div>

<script>
function generate() {
    const year = parseInt(document.getElementById('year').value);
    let wikiResult = "";
    let htmlResult = "";

    for (let m = 0; m < 12; m++) {
        const firstDay = new Date(year, m, 1);
        const lastDay = new Date(year, m + 1, 0);
        let curD = 1;
        let dow = firstDay.getDay();

        // --- wiki構文生成 ---
        let wikiMonth = `|>|>|>|>|>|>|BGCOLOR(#ccccff):CENTER:${m + 1}月|\n`;
        wikiMonth += `|BGCOLOR(#eeeeff):CENTER:&color(#ff0000){日}|BGCOLOR(#eeeeff):CENTER:月|BGCOLOR(#eeeeff):CENTER:火|BGCOLOR(#eeeeff):CENTER:水|BGCOLOR(#eeeeff):CENTER:木|BGCOLOR(#eeeeff):CENTER:金|BGCOLOR(#eeeeff):CENTER:&color(deepskyblue){土}|\n`;

        // --- プレビュー用HTML生成 ---
        let htmlMonth = `<table><tr><td colspan="7" style="background-color:#ccccff;">${m + 1}月</td></tr>`;
        htmlMonth += `<tr><td style="background-color:#eeeeff; color:#ff0000;">日</td><td style="background-color:#eeeeff;">月</td><td style="background-color:#eeeeff;">火</td><td style="background-color:#eeeeff;">水</td><td style="background-color:#eeeeff;">木</td><td style="background-color:#eeeeff;">金</td><td style="background-color:#eeeeff; color:deepskyblue;">土</td></tr>`;

        let wikiRow = "|".repeat(dow + 1);
        let htmlRow = "<tr>" + "<td></td>".repeat(dow);

        while (curD <= lastDay.getDate()) {
            let color = "";
            if (dow === 0) color = "#ff0000";
            if (dow === 6) color = "deepskyblue";

            let dateContent = color ? `&color(${color}){${curD}}` : `${curD}`;
            let htmlContent = color ? `<span style="color:${color}">${curD}</span>` : `${curD}`;

            wikiRow += `CENTER:${dateContent}|`;
            htmlRow += `<td>${htmlContent}</td>`;

            if (dow === 6) {
                wikiMonth += wikiRow + "\n";
                wikiRow = "|";
                htmlMonth += htmlRow + "</tr>";
                htmlRow = "<tr>";
            }
            curD++;
            dow = (dow + 1) % 7;
        }

        // 最終週の埋め
        if (dow !== 0) {
            wikiMonth += wikiRow + "|".repeat(7 - dow) + "\n";
            htmlMonth += htmlRow + "<td></td>".repeat(7 - dow) + "</tr>";
        } else if (wikiRow !== "|") {
            // ちょうど土曜日で終わった場合、htmlRowが<tr>のみで残っているのを閉じる処理
            htmlMonth += htmlRow + "</tr>";
        }
        
        wikiResult += wikiMonth + "\n";
        htmlResult += htmlMonth + "</table><br>"; 
    }

    document.getElementById('output').value = wikiResult.trim();
    document.getElementById('preview-area').innerHTML = htmlResult;
}

async function copyText() {
    const text = document.getElementById('output').value;
    if (!text) return;
    await navigator.clipboard.writeText(text);
    alert("コピーしました。atwikiの編集画面に貼り付けてください。");
}
</script>

</body>
</html>
